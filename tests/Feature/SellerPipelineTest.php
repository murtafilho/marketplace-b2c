<?php

namespace Tests\Feature;

use App\Models\User;
use App\Models\SellerProfile;
use App\Models\Category;
use App\Models\Product;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;
use Tests\TestCase;

class SellerPipelineTest extends TestCase
{
    use RefreshDatabase;

    /**
     * Test complete seller pipeline from registration to product approval
     */
    public function test_complete_seller_pipeline(): void
    {
        Storage::fake('public');
        
        echo "\nüß™ TESTANDO PIPELINE COMPLETO DO VENDEDOR\n";
        echo str_repeat("=", 60) . "\n";

        // 1. P√ÅGINA INICIAL - Verificar se link "Vender no valedosol.org" funciona
        echo "\n1. üì± Testando p√°gina inicial...\n";
        $homeResponse = $this->get('/');
        $homeResponse->assertStatus(200);
        $homeResponse->assertSee('Vender no valedosol.org');
        echo "   ‚úÖ P√°gina inicial carregada\n";
        echo "   ‚úÖ Link 'Vender no valedosol.org' presente\n";

        // 2. REGISTRO DE VENDEDOR - Criar conta
        echo "\n2. üë§ Testando registro de vendedor...\n";
        $registerResponse = $this->post('/register', [
            'name' => 'Jo√£o Vendedor Silva',
            'email' => 'joao.vendedor@teste.com',
            'phone' => '(11) 99999-8888',
            'password' => 'senha123456',
            'password_confirmation' => 'senha123456',
            'role' => 'seller',
        ]);

        $registerResponse->assertRedirect(route('seller.onboarding.index'));
        echo "   ‚úÖ Vendedor registrado com sucesso\n";
        echo "   ‚úÖ Redirecionado para onboarding\n";

        // Verificar se usu√°rio foi criado corretamente
        $user = User::where('email', 'joao.vendedor@teste.com')->first();
        $this->assertNotNull($user);
        $this->assertEquals('seller', $user->role);
        echo "   ‚úÖ Usu√°rio criado como 'seller'\n";

        // Verificar se SellerProfile foi criado
        $sellerProfile = $user->sellerProfile;
        $this->assertNotNull($sellerProfile);
        $this->assertEquals('pending', $sellerProfile->status);
        $this->assertEquals('Jo√£o Vendedor Silva', $sellerProfile->company_name);
        echo "   ‚úÖ SellerProfile criado com status 'pending'\n";

        // 3. ONBOARDING - Completar perfil
        echo "\n3. üè™ Testando processo de onboarding...\n";
        
        // Verificar acesso √† p√°gina de onboarding
        $onboardingResponse = $this->actingAs($user)->get('/seller/onboarding');
        $onboardingResponse->assertStatus(200);
        $onboardingResponse->assertSee('Completar Cadastro de Vendedor');
        echo "   ‚úÖ P√°gina de onboarding acess√≠vel\n";

        // Completar onboarding com documentos
        $addressProof = UploadedFile::fake()->create('comprovante_endereco.pdf', 1000, 'application/pdf');
        $identityProof = UploadedFile::fake()->create('documento_identidade.pdf', 1000, 'application/pdf');

        $onboardingData = [
            'company_name' => 'Loja do Jo√£o Vendedor',
            'document_type' => 'cpf',
            'document_number' => '123.456.789-01',
            'phone' => '(11) 99999-8888',
            'address' => 'Rua do Com√©rcio, 123',
            'city' => 'S√£o Paulo',
            'state' => 'SP',
            'postal_code' => '01234-567',
            'bank_name' => 'Banco do Brasil',
            'bank_agency' => '1234',
            'bank_account' => '12345-6',
            'address_proof' => $addressProof,
            'identity_proof' => $identityProof,
        ];

        $onboardingSubmitResponse = $this->actingAs($user)->post('/seller/onboarding', $onboardingData);
        $onboardingSubmitResponse->assertRedirect(route('seller.pending'));
        echo "   ‚úÖ Onboarding completado com sucesso\n";

        // Verificar se dados foram salvos
        $sellerProfile->refresh();
        $this->assertEquals('pending_approval', $sellerProfile->status);
        $this->assertEquals('Loja do Jo√£o Vendedor', $sellerProfile->company_name);
        $this->assertEquals('cpf', $sellerProfile->document_type);
        $this->assertNotNull($sellerProfile->submitted_at);
        echo "   ‚úÖ Status atualizado para 'pending_approval'\n";
        echo "   ‚úÖ Dados do onboarding salvos corretamente\n";

        // Verificar upload de documentos
        Storage::disk('public')->assertExists($sellerProfile->address_proof_path);
        Storage::disk('public')->assertExists($sellerProfile->identity_proof_path);
        echo "   ‚úÖ Documentos enviados e salvos\n";

        // Verificar p√°gina de status pendente
        $pendingResponse = $this->actingAs($user)->get('/seller/pending');
        $pendingResponse->assertStatus(200);
        $pendingResponse->assertSee('Aguardando Aprova√ß√£o');
        echo "   ‚úÖ P√°gina de status pendente funcionando\n";

        // 4. APROVA√á√ÉO PELO ADMIN - Simular aprova√ß√£o
        echo "\n4. ‚≠ê Testando aprova√ß√£o pelo administrador...\n";
        
        // Criar admin para testar aprova√ß√£o
        $admin = User::factory()->create(['role' => 'admin']);
        
        // Testar acesso √† p√°gina de gerenciamento de vendedores
        $sellersResponse = $this->actingAs($admin)->get('/admin/sellers');
        $sellersResponse->assertStatus(200);
        $sellersResponse->assertSee('Jo√£o Vendedor Silva');
        echo "   ‚úÖ Admin pode acessar lista de vendedores\n";

        // Testar p√°gina de detalhes do vendedor
        $sellerShowResponse = $this->actingAs($admin)->get("/admin/sellers/{$sellerProfile->id}");
        $sellerShowResponse->assertStatus(200);
        $sellerShowResponse->assertSee('Loja do Jo√£o Vendedor');
        echo "   ‚úÖ Admin pode ver detalhes do vendedor\n";

        // Aprovar vendedor
        $approveResponse = $this->actingAs($admin)->post("/admin/sellers/{$sellerProfile->id}/approve");
        $approveResponse->assertRedirect();
        echo "   ‚úÖ Vendedor aprovado pelo admin\n";

        // Verificar se status foi atualizado
        $sellerProfile->refresh();
        $this->assertEquals('approved', $sellerProfile->status);
        $this->assertNotNull($sellerProfile->approved_at);
        $this->assertEquals($admin->id, $sellerProfile->approved_by);
        echo "   ‚úÖ Status atualizado para 'approved'\n";

        // 5. CADASTRO DE PRODUTOS - Testar vendedor aprovado
        echo "\n5. üì¶ Testando cadastro de produtos...\n";
        
        // Criar categoria para o produto
        $category = Category::factory()->create([
            'name' => 'Eletr√¥nicos',
            'slug' => 'eletronicos',
            'is_active' => true
        ]);
        echo "   ‚úÖ Categoria criada: {$category->name}\n";

        // Verificar acesso ao dashboard do vendedor
        $dashboardResponse = $this->actingAs($user)->get('/seller/dashboard');
        $dashboardResponse->assertStatus(200);
        $dashboardResponse->assertSee('Ol√°,');
        echo "   ‚úÖ Dashboard do vendedor acess√≠vel\n";

        // Verificar acesso √† p√°gina de produtos
        $productsResponse = $this->actingAs($user)->get('/seller/products');
        $productsResponse->assertStatus(200);
        $productsResponse->assertSee('Meus Produtos');
        echo "   ‚úÖ P√°gina de produtos acess√≠vel\n";

        // Testar cria√ß√£o de produto
        $productImage = UploadedFile::fake()->image('produto.jpg', 800, 600);

        $productData = [
            'name' => 'Smartphone Samsung Galaxy A54',
            'category_id' => $category->id,
            'description' => 'Excelente smartphone com c√¢mera de 50MP e bateria de longa dura√ß√£o.',
            'short_description' => 'Smartphone Samsung Galaxy A54 128GB',
            'price' => 1299.99,
            'compare_at_price' => 1499.99,
            'stock_quantity' => 50,
            'weight' => 0.202,
            'length' => 15.8,
            'width' => 7.4,
            'height' => 0.8,
            'brand' => 'Samsung',
            'model' => 'Galaxy A54',
            'warranty_months' => 12,
            // Status ser√° 'draft' por padr√£o - comportamento correto
            'images' => [$productImage],
        ];

        $createProductResponse = $this->actingAs($user)->post('/seller/products', $productData);
        $createProductResponse->assertRedirect();
        echo "   ‚úÖ Produto criado com sucesso\n";

        // Verificar se produto foi salvo
        $product = Product::where('name', 'Smartphone Samsung Galaxy A54')->first();
        $this->assertNotNull($product);
        $this->assertEquals($sellerProfile->id, $product->seller_id);
        $this->assertEquals('draft', $product->status);
        $this->assertEquals(1299.99, $product->price);
        echo "   ‚úÖ Dados do produto salvos corretamente\n";

        // Verificar upload da imagem
        $this->assertTrue($product->images->count() > 0);
        Storage::disk('public')->assertExists($product->images->first()->file_path);
        echo "   ‚úÖ Imagem do produto enviada e salva\n";

        // 6. VERIFICA√á√ÉO FINAL
        echo "\n6. üéØ Verifica√ß√£o final do pipeline...\n";
        
        // Verificar se produto aparece na p√°gina inicial
        $finalHomeResponse = $this->get('/');
        $finalHomeResponse->assertStatus(200);
        // O produto pode n√£o aparecer na home se n√£o estiver em destaque, mas deve estar no sistema
        echo "   ‚úÖ Sistema funcionando corretamente\n";

        // Estat√≠sticas finais
        $totalProducts = Product::count();
        $totalSellers = SellerProfile::where('status', 'approved')->count();
        $totalUsers = User::count();

        echo "\nüìä ESTAT√çSTICAS DO TESTE:\n";
        echo "   ‚Ä¢ Produtos criados: {$totalProducts}\n";
        echo "   ‚Ä¢ Vendedores aprovados: {$totalSellers}\n";
        echo "   ‚Ä¢ Usu√°rios totais: {$totalUsers}\n";

        echo "\nüéâ PIPELINE DO VENDEDOR TESTADO COM SUCESSO!\n";
        echo str_repeat("=", 60) . "\n";

        // Assertions finais
        $this->assertTrue($totalProducts > 0);
        $this->assertTrue($totalSellers > 0);
        $this->assertTrue($totalUsers >= 2); // Pelo menos vendedor + admin
    }

    /**
     * Test seller rejection workflow
     */
    public function test_seller_rejection_workflow(): void
    {
        echo "\nüö´ TESTANDO WORKFLOW DE REJEI√á√ÉO DE VENDEDOR\n";
        echo str_repeat("=", 50) . "\n";

        // Criar vendedor pendente
        $user = User::factory()->create(['role' => 'seller']);
        $sellerProfile = SellerProfile::factory()->create([
            'user_id' => $user->id,
            'status' => 'pending_approval',
            'company_name' => 'Empresa Teste Rejei√ß√£o'
        ]);

        // Criar admin
        $admin = User::factory()->create(['role' => 'admin']);

        echo "   ‚úÖ Vendedor criado com status 'pending_approval'\n";

        // Rejeitar vendedor
        $rejectResponse = $this->actingAs($admin)->post("/admin/sellers/{$sellerProfile->id}/reject", [
            'rejection_reason' => 'Documentos inv√°lidos ou incompletos.'
        ]);

        $rejectResponse->assertRedirect();
        echo "   ‚úÖ Vendedor rejeitado pelo admin\n";

        // Verificar se dados foram atualizados
        $sellerProfile->refresh();
        $this->assertEquals('rejected', $sellerProfile->status);
        $this->assertEquals('Documentos inv√°lidos ou incompletos.', $sellerProfile->rejection_reason);
        $this->assertNotNull($sellerProfile->rejected_at);
        $this->assertEquals($admin->id, $sellerProfile->rejected_by);

        echo "   ‚úÖ Status atualizado para 'rejected'\n";
        echo "   ‚úÖ Motivo da rejei√ß√£o salvo\n";
        echo "   ‚úÖ Data e respons√°vel pela rejei√ß√£o registrados\n";

        echo "\nüéØ WORKFLOW DE REJEI√á√ÉO FUNCIONANDO CORRETAMENTE!\n";
    }
}